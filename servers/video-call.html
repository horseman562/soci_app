<!DOCTYPE html>
<html>
<head>
    <title>WebRTC Video Call</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f0f0f0;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .video-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        video {
            width: 300px;
            height: 200px;
            background: #000;
            border-radius: 10px;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn-primary { background: #007cba; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-primary:hover { background: #005a87; }
        .btn-success:hover { background: #1e7e34; }
        .btn-danger:hover { background: #c82333; }
        .user-info {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .logs {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.connected { background: #d4edda; color: #155724; }
        .status.connecting { background: #fff3cd; color: #856404; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¥ WebRTC Video Call</h1>
        
        <div class="user-info">
            <h3>Your User ID: <span id="userId"></span></h3>
            <p>Share this page with someone else and use each other's User IDs to make a call!</p>
        </div>

        <div class="status disconnected" id="connectionStatus">
            WebSocket: Disconnected
        </div>

        <div class="controls">
            <input type="number" id="targetUserId" placeholder="Enter target user ID" min="1" max="999">
            <button class="btn-primary" onclick="startCall()">ðŸ“ž Start Call</button>
            <button class="btn-danger" onclick="endCall()">ðŸ“µ End Call</button>
            <button class="btn-success" onclick="toggleAudio()">ðŸŽ¤ Toggle Audio</button>
            <button class="btn-success" onclick="toggleVideo()">ðŸ“¹ Toggle Video</button>
        </div>

        <div class="video-container">
            <div>
                <h4>Your Video</h4>
                <video id="localVideo" autoplay muted playsinline></video>
            </div>
            <div>
                <h4>Remote Video</h4>
                <video id="remoteVideo" autoplay playsinline></video>
            </div>
        </div>

        <h3>Call Logs:</h3>
        <div id="logs" class="logs"></div>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <script>
        let localVideo = document.getElementById('localVideo');
        let remoteVideo = document.getElementById('remoteVideo');
        let ws;
        let pc;
        let localStream;
        let userId = Math.floor(Math.random() * 900) + 100; // Random 3-digit ID
        
        document.getElementById('userId').textContent = userId;

        const iceServers = [
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' },
            { urls: 'stun:stun.cloudflare.com:3478' },
            { urls: 'stun:stun.nextcloud.com:443' }
        ];

        function log(message) {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logsDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function updateConnectionStatus(status, message) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.className = `status ${status}`;
            statusDiv.textContent = message;
        }

        // Connect to WebSocket signaling server
        function connectWebSocket() {
            ws = new WebSocket('ws://localhost:3001');
            
            ws.onopen = () => {
                log('ðŸŸ¢ Connected to signaling server');
                updateConnectionStatus('connected', 'WebSocket: Connected');
                
                // Register user
                ws.send(JSON.stringify({
                    type: 'register',
                    userId: userId
                }));
                log(`ðŸ“ Registered as user ${userId}`);
            };

            ws.onmessage = async (event) => {
                const message = JSON.parse(event.data);
                log(`ðŸ“¨ Received: ${message.type}`);
                
                switch (message.type) {
                    case 'offer':
                        await handleOffer(message);
                        break;
                    case 'answer':
                        await handleAnswer(message);
                        break;
                    case 'candidate':
                        await handleCandidate(message);
                        break;
                }
            };

            ws.onclose = () => {
                log('ðŸ”´ Disconnected from signaling server');
                updateConnectionStatus('disconnected', 'WebSocket: Disconnected');
            };

            ws.onerror = (error) => {
                log(`âŒ WebSocket error: ${error}`);
                updateConnectionStatus('disconnected', 'WebSocket: Error');
            };
        }

        // Initialize local media
        async function initLocalMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                
                localVideo.srcObject = localStream;
                log('âœ… Local media initialized');
                return true;
            } catch (error) {
                log(`âŒ Error accessing media: ${error.message}`);
                return false;
            }
        }

        // Create peer connection
        function createPeerConnection() {
            pc = new RTCPeerConnection({ iceServers });

            // Add local tracks
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    pc.addTrack(track, localStream);
                });
                log('ðŸŽµ Local tracks added to peer connection');
            }

            // Handle ICE candidates
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    log(`ðŸ”¥ ICE candidate generated: ${event.candidate.candidate.substring(0, 50)}...`);
                    
                    const targetUserId = document.getElementById('targetUserId').value;
                    if (ws && ws.readyState === WebSocket.OPEN && targetUserId) {
                        ws.send(JSON.stringify({
                            type: 'candidate',
                            target: parseInt(targetUserId),
                            userId: userId,
                            candidate: event.candidate.candidate,
                            sdpMid: event.candidate.sdpMid,
                            sdpMLineIndex: event.candidate.sdpMLineIndex
                        }));
                        log(`ðŸ“¤ ICE candidate sent to user ${targetUserId}`);
                    }
                } else {
                    log('âœ… ICE gathering complete');
                }
            };

            // Handle remote stream
            pc.ontrack = (event) => {
                log('ðŸ“º Remote stream received');
                remoteVideo.srcObject = event.streams[0];
            };

            // ICE connection state
            pc.oniceconnectionstatechange = () => {
                log(`ðŸ”— ICE connection state: ${pc.iceConnectionState}`);
                if (pc.iceConnectionState === 'connected' || pc.iceConnectionState === 'completed') {
                    updateConnectionStatus('connected', 'Call: Connected');
                } else if (pc.iceConnectionState === 'connecting' || pc.iceConnectionState === 'checking') {
                    updateConnectionStatus('connecting', 'Call: Connecting...');
                } else {
                    updateConnectionStatus('disconnected', 'Call: Disconnected');
                }
            };

            // ICE gathering state
            pc.onicegatheringstatechange = () => {
                log(`â„ï¸ ICE gathering state: ${pc.iceGatheringState}`);
            };

            return pc;
        }

        // Start call (create offer)
        async function startCall() {
            const targetUserId = document.getElementById('targetUserId').value;
            if (!targetUserId) {
                alert('Please enter target user ID');
                return;
            }

            log(`ðŸ“ž Starting call to user ${targetUserId}`);
            
            // Initialize media if not done
            if (!localStream) {
                const success = await initLocalMedia();
                if (!success) return;
            }

            // Create peer connection
            createPeerConnection();

            try {
                // Create offer
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                log('âœ… Offer created and set as local description');
                log('ðŸ”¥ ICE candidates should start generating now...');

                // Send offer via WebSocket
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'offer',
                        target: parseInt(targetUserId),
                        initiatorId: userId,
                        sdp: offer.sdp
                    }));
                    log(`ðŸ“¤ Offer sent to user ${targetUserId}`);
                }
            } catch (error) {
                log(`âŒ Error creating offer: ${error.message}`);
            }
        }

        // Handle incoming offer
        async function handleOffer(message) {
            log(`ðŸ“¨ Received offer from user ${message.initiatorId}`);
            
            // Initialize media if not done
            if (!localStream) {
                const success = await initLocalMedia();
                if (!success) return;
            }

            // Create peer connection
            createPeerConnection();

            try {
                // Set remote description
                await pc.setRemoteDescription({
                    type: 'offer',
                    sdp: message.sdp
                });
                log('âœ… Remote offer set');

                // Create answer
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                log('âœ… Answer created and set as local description');
                log('ðŸ”¥ ICE candidates should start generating now...');

                // Send answer
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'answer',
                        target: message.initiatorId,
                        userId: userId,
                        sdp: answer.sdp
                    }));
                    log(`ðŸ“¤ Answer sent to user ${message.initiatorId}`);
                }

                // Auto-fill target user ID for convenience
                document.getElementById('targetUserId').value = message.initiatorId;
            } catch (error) {
                log(`âŒ Error handling offer: ${error.message}`);
            }
        }

        // Handle answer
        async function handleAnswer(message) {
            log(`ðŸ“¨ Received answer from user ${message.userId}`);
            
            try {
                await pc.setRemoteDescription({
                    type: 'answer',
                    sdp: message.sdp
                });
                log('âœ… Remote answer set - connection should establish');
            } catch (error) {
                log(`âŒ Error handling answer: ${error.message}`);
            }
        }

        // Handle ICE candidate
        async function handleCandidate(message) {
            log(`ðŸ“¨ Received ICE candidate from user ${message.userId}`);
            
            try {
                await pc.addIceCandidate({
                    candidate: message.candidate,
                    sdpMid: message.sdpMid,
                    sdpMLineIndex: message.sdpMLineIndex
                });
                log('âœ… ICE candidate added');
            } catch (error) {
                log(`âŒ Error adding ICE candidate: ${error.message}`);
            }
        }

        // End call
        function endCall() {
            log('ðŸ“µ Ending call');
            
            if (pc) {
                pc.close();
                pc = null;
            }
            
            if (remoteVideo.srcObject) {
                remoteVideo.srcObject = null;
            }
            
            updateConnectionStatus('disconnected', 'Call: Ended');
        }

        // Toggle audio
        function toggleAudio() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    log(`ðŸŽ¤ Audio ${audioTrack.enabled ? 'enabled' : 'disabled'}`);
                }
            }
        }

        // Toggle video
        function toggleVideo() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    log(`ðŸ“¹ Video ${videoTrack.enabled ? 'enabled' : 'disabled'}`);
                }
            }
        }

        // Initialize on page load
        window.onload = () => {
            log(`ðŸš€ WebRTC Video Call initialized for user ${userId}`);
            connectWebSocket();
        };

        // Clean up on page unload
        window.onbeforeunload = () => {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (ws) {
                ws.close();
            }
        };
    </script>
</body>
</html>